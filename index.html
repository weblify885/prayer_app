<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Islamic Prayer Times</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .card {
            background-color: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .next-prayer-card {
            background: linear-gradient(135deg, #10B981, #059669);
        }
        select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke-width='2' stroke='white'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M19.5 8.25l-7.5 7.5-7.5-7.5' /%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1.25em;
        }
        .notification-bell.active {
            color: #34D399; /* emerald-400 */
        }
        .view-toggle button.active, .main-nav button.active {
            background-color: #059669; /* emerald-600 */
            color: white;
        }
        #monthly-view-container, #privacy-policy-content, .content-section {
            max-height: 60vh;
            overflow-y: auto;
        }
        #suggestions-box {
            max-height: 150px;
            overflow-y: auto;
        }
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
        }
        #qibla-needle {
            transition: transform 0.5s ease-out;
        }
    </style>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9042557168555887"
     crossorigin="anonymous"></script>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen p-4">

    <div id="app-container" class="w-full max-w-lg mx-auto">
        
        <div id="loader" class="text-center hidden">
            <svg class="animate-spin h-8 w-8 text-white mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="text-lg">Fetching prayer times...</p>
        </div>

        <div id="error-message" class="hidden text-center card p-6 rounded-2xl">
            <h2 class="text-xl font-bold text-red-400 mb-2">Error</h2>
            <p id="error-text" class="text-gray-300"></p>
            <button onclick="showLocationConsent()" class="mt-4 bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">Try Again</button>
        </div>

        <div id="main-content" class="hidden">
            <!-- Main Navigation -->
            <nav class="main-nav flex justify-center mb-6 bg-gray-800 rounded-lg p-1 text-sm">
                <button data-target="prayer-times-view" class="px-3 py-2 font-medium rounded-md flex-1 text-center active">Prayer Times</button>
                <button data-target="qibla-view" class="px-3 py-2 font-medium rounded-md flex-1 text-center">Qibla</button>
                <button data-target="about-view" class="px-3 py-2 font-medium rounded-md flex-1 text-center">About</button>
                <button data-target="articles-view" class="px-3 py-2 font-medium rounded-md flex-1 text-center">Articles</button>
                <button data-target="faq-view" class="px-3 py-2 font-medium rounded-md flex-1 text-center">FAQ</button>
            </nav>

            <!-- Prayer Times View -->
            <div id="prayer-times-view" class="page-view">
                <div class="text-center mb-4">
                    <h1 id="date" class="text-2xl font-bold"></h1>
                    <p id="hijri-date" class="text-md text-gray-400"></p>
                    <p id="location" class="text-gray-400"></p>
                </div>
                <div class="card p-4 rounded-2xl mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="relative">
                            <label for="location-input" class="block text-sm font-medium text-gray-300 mb-1">Change Location</label>
                            <div class="flex gap-2">
                                <input type="text" id="location-input" placeholder="Enter city name" class="w-full bg-gray-700 text-white border-gray-600 rounded-lg px-3 py-2 focus:ring-emerald-500 focus:border-emerald-500" autocomplete="off">
                                <button onclick="searchLocation()" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-3 rounded-lg transition-colors"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" /></svg></button>
                            </div>
                            <div id="suggestions-box" class="absolute z-10 w-full mt-1 bg-gray-800 border border-gray-600 rounded-lg shadow-lg hidden"></div>
                        </div>
                        <div>
                            <label for="method-select" class="block text-sm font-medium text-gray-300 mb-1">Calculation Method</label>
                            <select id="method-select" class="w-full bg-gray-700 text-white border-gray-600 rounded-lg px-3 py-2 focus:ring-emerald-500 focus:border-emerald-500">
                                <option value="2">ISNA (North America)</option><option value="3">Muslim World League</option><option value="4">Umm Al-Qura, Makkah</option><option value="5">Egyptian General Authority</option><option value="1">University of Islamic Sciences, Karachi</option><option value="7">University of Tehran</option><option value="8">Gulf Region</option>
                            </select>
                        </div>
                    </div>
                     <button onclick="showLocationConsent()" class="mt-3 text-sm text-emerald-400 hover:text-emerald-300 w-full text-center">Use my current location</button>
                </div>
                <div class="next-prayer-card text-center p-6 rounded-2xl mb-8 shadow-lg">
                    <p class="text-lg font-medium text-emerald-100">Time until</p>
                    <h2 id="next-prayer-name" class="text-4xl font-bold my-1"></h2>
                    <div id="countdown" class="text-5xl font-bold tracking-wider">00:00:00</div>
                </div>
                <div class="view-toggle flex justify-center mb-4 bg-gray-800 rounded-lg p-1">
                    <button id="daily-view-btn" class="px-4 py-2 text-sm font-medium rounded-md w-1/2 active">Daily</button>
                    <button id="monthly-view-btn" class="px-4 py-2 text-sm font-medium rounded-md w-1/2">Monthly</button>
                </div>
                <div id="daily-view"><div id="prayer-times-list" class="space-y-3"></div></div>
                <div id="monthly-view" class="hidden"><div id="monthly-view-container" class="card p-2 rounded-lg"><table class="w-full text-sm text-left"><thead class="text-xs text-gray-300 uppercase bg-gray-700/50"><tr><th class="px-4 py-2">Date</th><th class="px-2 py-2">Fajr</th><th class="px-2 py-2">Dhuhr</th><th class="px-2 py-2">Asr</th><th class="px-2 py-2">Maghrib</th><th class="px-2 py-2">Isha</th></tr></thead><tbody id="monthly-table-body"></tbody></table></div></div>
            </div>
            
            <!-- Qibla View -->
            <div id="qibla-view" class="page-view hidden">
                <div class="card p-6 rounded-2xl content-section text-center">
                    <h2 class="text-2xl font-bold text-white mb-4">Qibla Direction</h2>
                    <div id="qibla-permission-prompt">
                        <p class="text-gray-300 mb-4">Click the button below to start the compass. You may need to grant permission to access your device's motion sensors.</p>
                        <button id="start-qibla-btn" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-4 rounded-lg">Start Compass</button>
                    </div>
                    <div id="qibla-compass-container" class="hidden">
                        <div class="relative w-48 h-48 mx-auto my-4 bg-gray-700/50 rounded-full border-4 border-gray-500 flex items-center justify-center" id="compass-rose">
                            <div class="absolute w-full h-full text-xs text-gray-400">
                                <div class="absolute top-1 left-1/2 -translate-x-1/2">N</div>
                                <div class="absolute bottom-1 left-1/2 -translate-x-1/2">S</div>
                                <div class="absolute left-2 top-1/2 -translate-y-1/2">W</div>
                                <div class="absolute right-2 top-1/2 -translate-y-1/2">E</div>
                            </div>
                            <div id="qibla-needle" class="w-1 h-20 bg-emerald-400 origin-bottom absolute bottom-1/2" style="transform: rotate(0deg);">
                                <div class="w-3 h-3 border-2 border-emerald-400 bg-gray-900 rounded-full absolute -top-1.5 -left-1"></div>
                            </div>
                        </div>
                        <p class="text-lg">Qibla is at <span id="qibla-direction-degrees" class="font-bold">...</span>&deg;</p>
                    </div>
                    <div id="qibla-error" class="text-red-400 mt-4 hidden"></div>
                </div>
            </div>

            <!-- About View -->
            <div id="about-view" class="page-view hidden">
                <div class="card p-6 rounded-2xl content-section space-y-4">
                    <h2 class="text-2xl font-bold text-white mb-4">About Calculation Methods</h2>
                    <div><h3 class="font-semibold text-lg text-emerald-400">ISNA (Islamic Society of North America)</h3><p class="text-gray-300 text-sm">Uses a Fajr angle of 15 degrees and an Isha angle of 15 degrees. Widely used in North America.</p></div>
                    <div><h3 class="font-semibold text-lg text-emerald-400">Muslim World League</h3><p class="text-gray-300 text-sm">A common standard using a Fajr angle of 18 degrees and an Isha angle of 17 degrees. Used in parts of Europe, the Far East, and America.</p></div>
                    <div><h3 class="font-semibold text-lg text-emerald-400">Umm Al-Qura, Makkah</h3><p class="text-gray-300 text-sm">Uses a Fajr angle of 18.5 degrees and a fixed Isha time of 90 minutes after Maghrib (120 during Ramadan). Standard in Saudi Arabia.</p></div>
                    <div><h3 class="font-semibold text-lg text-emerald-400">Egyptian General Authority</h3><p class="text-gray-300 text-sm">Uses a Fajr angle of 19.5 degrees and an Isha angle of 17.5 degrees. Used in Africa, Syria, and Iraq.</p></div>
                    <div><h3 class="font-semibold text-lg text-emerald-400">University of Islamic Sciences, Karachi</h3><p class="text-gray-300 text-sm">Uses a Fajr angle of 18 degrees and an Isha angle of 18 degrees. Common in Pakistan, Bangladesh, India, and Afghanistan.</p></div>
                </div>
            </div>

            <!-- Articles View -->
            <div id="articles-view" class="page-view hidden">
                <div class="card p-6 rounded-2xl content-section space-y-8">
                    <article>
                        <h2 class="text-2xl font-bold text-white mb-4">The Significance of Salah (Prayer)</h2>
                        <img src="https://images.unsplash.com/photo-1580048223961-2661a55a894a?q=80&w=400" class="rounded-lg mb-4" alt="Kaaba">
                        <p class="text-gray-300">Salah, the ritual prayer, is the second pillar of Islam and a fundamental act of worship that establishes a direct connection between a Muslim and Allah. It is performed five times a day at specific times: Fajr (dawn), Dhuhr (midday), Asr (late afternoon), Maghrib (sunset), and Isha (night). Each prayer is a spiritual refreshment, a reminder of our purpose in life, and a moment of peace and reflection away from worldly distractions.</p>
                        <p class="text-gray-300 mt-2">The Quran and Hadith emphasize the importance of prayer countless times. It is described as a key to paradise, a means of seeking forgiveness, and a way to attain righteousness and discipline. Performing Salah regularly instills a sense of gratitude, humility, and mindfulness, structuring a Muslim's day around the remembrance of God.</p>
                    </article>
                    <hr class="border-gray-700">
                    <article>
                        <h2 class="text-2xl font-bold text-white mb-4">The Purity of Wudu (Ablution)</h2>
                        <img src="https://images.unsplash.com/photo-1556403836-36a2b53e405c?q=80&w=400" class="rounded-lg mb-4" alt="Water for ablution">
                        <p class="text-gray-300">Wudu is the ritual washing performed by Muslims before prayer. It is a physical and spiritual purification. The act of washing the hands, face, arms, and feet is not merely for physical cleanliness but also serves as a means of washing away minor sins. The Prophet Muhammad (peace be upon him) said, "When a Muslim servant or a believer washes his face (in the course of Wudu), every sin he contemplated with his eyes will be washed away from his face with the water..."</p>
                        <p class="text-gray-300 mt-2">This preparation for prayer helps one to enter a state of mindfulness and reverence, leaving behind the impurities of the world to stand before God. It highlights the Islamic emphasis on both inner and outer purity.</p>
                    </article>
                    <hr class="border-gray-700">
                    <article>
                        <h2 class="text-2xl font-bold text-white mb-4">The Power of Dhikr (Remembrance)</h2>
                        <img src="https://images.unsplash.com/photo-1609597332169-55ac9683e3e1?q=80&w=400" class="rounded-lg mb-4" alt="Person holding prayer beads">
                        <p class="text-gray-300">Dhikr is the remembrance of Allah through the repetition of His names or phrases of praise and glorification. It is a powerful form of worship that can be done at any time and in any place. The Quran says, "Verily, in the remembrance of Allah do hearts find rest" (13:28). Engaging in Dhikr helps to keep the heart connected to the Divine, providing tranquility and strength in times of both ease and hardship.</p>
                        <p class="text-gray-300 mt-2">Whether through a tasbeeh (prayer beads) or simply on one's fingers, the act of remembering Allah keeps the tongue moist with His praise and the heart illuminated with His light. It is a simple yet profound practice that strengthens faith and brings immense reward.</p>
                    </article>
                </div>
            </div>

            <!-- FAQ View -->
            <div id="faq-view" class="page-view hidden">
                <div class="card p-6 rounded-2xl content-section space-y-4">
                    <h2 class="text-2xl font-bold text-white mb-4">Frequently Asked Questions</h2>
                    <div><h3 class="font-semibold text-lg text-emerald-400">Why does the app need my location?</h3><p class="text-gray-300 text-sm">Prayer times are calculated based on the position of the sun, which varies depending on your geographic coordinates (latitude and longitude). We need your location to provide the most accurate prayer times for your specific area.</p></div>
                    <div><h3 class="font-semibold text-lg text-emerald-400">Which calculation method should I use?</h3><p class="text-gray-300 text-sm">The best method depends on your region. Check with your local mosque or community to see which standard they follow. The "About" tab provides more details on each method.</p></div>
                    <div><h3 class="font-semibold text-lg text-emerald-400">How do notifications work?</h3><p class="text-gray-300 text-sm">Click the bell icon next to a prayer time to set a one-time notification. Your browser will ask for permission. The notification will trigger at the exact prayer time, and if you have an `adhan.mp3` file, it will play the call to prayer.</p></div>
                     <div><h3 class="font-semibold text-lg text-emerald-400">Is my data safe?</h3><p class="text-gray-300 text-sm">Yes. We only use your location to calculate prayer times. We do not store or share your location data. Please see our Privacy Policy for more details.</p></div>
                </div>
            </div>

            <footer class="text-center mt-8">
                <button id="privacy-policy-btn" class="text-sm text-gray-500 hover:text-gray-400">Privacy Policy</button>
            </footer>
        </div>
    </div>

    <!-- Modals and Audio -->
    <div id="location-consent-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden"><div class="card w-full max-w-sm p-6 rounded-2xl text-center"><h3 class="text-lg font-bold mb-2">Location Access</h3><p class="text-gray-300 mb-6">Allow location access to show prayer times for your current area.</p><div class="flex justify-center gap-4"><button id="deny-location-btn" class="px-6 py-2 rounded-lg bg-gray-600 hover:bg-gray-500">Deny</button><button id="allow-location-btn" class="px-6 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-500">Allow</button></div></div></div>
    <div id="privacy-policy-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden"><div class="card w-full max-w-2xl p-6 rounded-2xl"><div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold">Privacy Policy</h3><button id="close-privacy-btn" class="text-gray-400 hover:text-white">&times;</button></div><div id="privacy-policy-content" class="text-gray-300 space-y-3 text-sm"><p><strong>Last Updated: July 10, 2025</strong></p><p>This Privacy Policy explains how we collect, use, and disclose information about you when you use our Islamic Prayer Times application.</p><div><h4 class="font-semibold text-white mb-1">1. Information We Collect</h4><p><strong>Location Data:</strong> We collect your precise geographic location (latitude and longitude) to calculate and display accurate Islamic prayer times for your specific area. This data is fundamental to the core functionality of the app.</p></div><div><h4 class="font-semibold text-white mb-1">2. How We Use Your Information</h4><p>Your location data is used exclusively to provide you with the services you request... We do not store your location history...</p></div><div><h4 class="font-semibold text-white mb-1">3. Advertising and Cookies</h4><p>We may use Google AdSense...<ul><li>Third-party vendors, including Google, use cookies to serve ads...</li><li>Google's use of advertising cookies enables it and its partners to serve ads...</li><li>You may opt out of personalized advertising by visiting <a href="https://www.google.com/settings/ads" target="_blank" class="text-emerald-400 hover:underline">Ads Settings</a>.</li></ul></p></div><div><h4 class="font-semibold text-white mb-1">4. Your Consent</h4><p>By using our application and allowing location access, you consent to the collection and use of your location data as described in this policy...</p></div></div></div></div>
    <audio id="adhan-audio" src="adhan.mp3" preload="auto"></audio>

    <script>
        // DOM Elements
        const loader = document.getElementById('loader');
        const mainContent = document.getElementById('main-content');
        const errorMessage = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');
        const dateEl = document.getElementById('date');
        const hijriDateEl = document.getElementById('hijri-date');
        const locationEl = document.getElementById('location');
        const locationConsentModal = document.getElementById('location-consent-modal');
        const privacyPolicyModal = document.getElementById('privacy-policy-modal');
        const mainNavButtons = document.querySelectorAll('.main-nav button');
        const pageViews = document.querySelectorAll('.page-view');
        
        // App State
        let countdownInterval;
        let currentLatitude, currentLongitude;
        let currentMethod = 2;
        let scheduledNotifications = {};
        let debounceTimer;

        // --- 1. Initialization & Consent ---
        function showLocationConsent() {
            errorMessage.classList.add('hidden');
            locationConsentModal.classList.remove('hidden');
        }

        function requestLocationPermission() {
            locationConsentModal.classList.add('hidden');
            showLoader();
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    position => handleNewCoordinates(position.coords.latitude, position.coords.longitude),
                    () => {
                        showError("Geolocation failed. Please search for a location manually.");
                        handleNewCoordinates(21.4225, 39.8262); // Fallback to Mecca
                    }
                );
            } else {
                 showError("Geolocation is not supported. Please search for a location manually.");
                 handleNewCoordinates(21.4225, 39.8262); // Fallback
            }
        }

        function handleNewCoordinates(latitude, longitude) {
            currentLatitude = latitude;
            currentLongitude = longitude;
            document.getElementById('monthly-table-body').innerHTML = '';
            if (document.getElementById('prayer-times-view').classList.contains('hidden')) {
                // If another view is active, don't fetch prayer times yet
            } else {
                fetchDailyData();
            }
            fetchLocationName();
        }

        // --- 2. Data Fetching ---
        async function fetchDailyData() {
            if (!currentLatitude) return;
            showLoader();
            try {
                const apiURL = `https://api.aladhan.com/v1/timings?latitude=${currentLatitude}&longitude=${currentLongitude}&method=${currentMethod}`;
                const response = await fetch(apiURL);
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                if (data.code === 200) {
                    displayPrayerTimes(data.data.timings);
                    startCountdown(data.data.timings);
                    displayDate(data.data.date);
                    showMainContent();
                } else { throw new Error(data.status); }
            } catch (error) { showError(`Failed to fetch daily prayer times. ${error.message}`); }
        }
        
        async function fetchMonthlyData() {
            if (!currentLatitude) return;
            showLoader();
            try {
                const today = new Date();
                const month = today.getMonth() + 1;
                const year = today.getFullYear();
                const apiURL = `https://api.aladhan.com/v1/calendar/${year}/${month}?latitude=${currentLatitude}&longitude=${currentLongitude}&method=${currentMethod}`;
                const response = await fetch(apiURL);
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                if (data.code === 200) {
                    displayMonthlyCalendar(data.data);
                    if (!dateEl.textContent) { displayDate(data.data[new Date().getDate() - 1].date); }
                    showMainContent();
                } else { throw new Error(data.status); }
            } catch (error) { showError(`Failed to fetch monthly prayer times. ${error.message}`); }
        }

        async function fetchLocationName() {
            try {
                const response = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${currentLatitude}&longitude=${currentLongitude}&localityLanguage=en`);
                const data = await response.json();
                locationEl.textContent = `${data.city || data.locality}, ${data.countryName}`;
            } catch (error) {
                console.warn("Could not fetch location name:", error);
                locationEl.textContent = `Lat: ${currentLatitude.toFixed(2)}, Lon: ${currentLongitude.toFixed(2)}`;
            }
        }
        
        // --- 3. UI Display & Navigation ---
        function switchView(targetId) {
            pageViews.forEach(view => {
                view.classList.toggle('hidden', view.id !== targetId);
            });
            mainNavButtons.forEach(button => {
                button.classList.toggle('active', button.dataset.target === targetId);
            });
        }

        function displayDate(dateData) {
            dateEl.textContent = dateData.readable;
            hijriDateEl.textContent = `${dateData.hijri.weekday.en} ${dateData.hijri.day} ${dateData.hijri.month.en}, ${dateData.hijri.year}`;
        }

        function displayPrayerTimes(timings) {
            const prayerTimesListEl = document.getElementById('prayer-times-list');
            prayerTimesListEl.innerHTML = '';
            const prayerOrder = ['Fajr', 'Dhuhr', 'Asr', 'Maghrib', 'Isha'];
            const todayStr = new Date().toDateString();
            prayerOrder.forEach(prayer => {
                const prayerTime = new Date(`${todayStr} ${timings[prayer]}`);
                const time = formatTime(timings[prayer]);
                const prayerEl = document.createElement('div');
                prayerEl.className = 'card flex justify-between items-center p-4 rounded-lg';
                const bellId = `bell-${prayer}`;
                const isScheduled = scheduledNotifications[prayer];
                prayerEl.innerHTML = `<span class="text-lg font-medium">${prayer}</span><div class="flex items-center gap-4"><span class="text-xl font-semibold">${time}</span><svg id="${bellId}" class="w-6 h-6 text-gray-400 hover:text-white cursor-pointer notification-bell ${isScheduled ? 'active' : ''}" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.857 17.082a23.848 23.848 0 005.454-1.31A8.967 8.967 0 0118 9.75v-.7V9A6 6 0 006 9v.75a8.967 8.967 0 01-2.312 6.022c1.733.64 3.56 1.085 5.455 1.31m5.714 0a24.255 24.255 0 01-5.714 0m5.714 0a3 3 0 11-5.714 0" /></svg></div>`;
                prayerTimesListEl.appendChild(prayerEl);
                document.getElementById(bellId).onclick = () => handleNotificationClick(prayer, prayerTime);
            });
        }
        
        function displayMonthlyCalendar(days) {
            const monthlyTableBody = document.getElementById('monthly-table-body');
            monthlyTableBody.innerHTML = '';
            days.forEach(day => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-700 hover:bg-gray-800/50';
                row.innerHTML = `<td class="px-4 py-3 font-medium">${day.date.readable}</td><td class="px-2 py-3">${formatTime(day.timings.Fajr)}</td><td class="px-2 py-3">${formatTime(day.timings.Dhuhr)}</td><td class="px-2 py-3">${formatTime(day.timings.Asr)}</td><td class="px-2 py-3">${formatTime(day.timings.Maghrib)}</td><td class="px-2 py-3">${formatTime(day.timings.Isha)}</td>`;
                monthlyTableBody.appendChild(row);
            });
        }

        // --- 4. Core Logic ---
        function startCountdown(timings) {
            if (countdownInterval) clearInterval(countdownInterval);
            const prayerTimes = getPrayerDateObjects(timings);
            const update = () => {
                const now = new Date();
                let nextPrayer = prayerTimes.find(p => p.time > now);
                if (!nextPrayer && prayerTimes.length > 0) {
                    const tomorrowFajrTime = new Date(prayerTimes[0].time);
                    tomorrowFajrTime.setDate(tomorrowFajrTime.getDate() + 1);
                    nextPrayer = { name: 'Fajr', time: tomorrowFajrTime };
                }
                updateCountdownDisplay(nextPrayer, now);
            };
            countdownInterval = setInterval(update, 1000);
            update();
        }

        function getPrayerDateObjects(timings) {
            const todayStr = new Date().toDateString();
            const prayerOrder = ['Fajr', 'Dhuhr', 'Asr', 'Maghrib', 'Isha'];
            return prayerOrder.filter(name => timings[name]).map(name => ({ name: name, time: new Date(`${todayStr} ${timings[name]}`) }));
        }
        
        function updateCountdownDisplay(nextPrayer, now) {
            const nextPrayerNameEl = document.getElementById('next-prayer-name');
            const countdownEl = document.getElementById('countdown');
            if (!nextPrayer) {
                nextPrayerNameEl.textContent = 'Done';
                countdownEl.textContent = '--:--:--';
                return;
            }
            const timeDiff = nextPrayer.time - now;
            if (timeDiff <= 0) { clearInterval(countdownInterval); fetchDailyData(); return; }
            const hours = Math.floor(timeDiff / (1000 * 60 * 60));
            const minutes = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((timeDiff % (1000 * 60)) / 1000);
            nextPrayerNameEl.textContent = nextPrayer.name;
            countdownEl.textContent = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            document.querySelectorAll('#prayer-times-list > div').forEach(div => {
                const prayerNameEl = div.querySelector('span:first-child');
                if (prayerNameEl && prayerNameEl.textContent === nextPrayer.name) { div.classList.add('bg-emerald-800', 'border-emerald-500'); } 
                else { div.classList.remove('bg-emerald-800', 'border-emerald-500'); }
            });
        }
        
        function handleNotificationClick(prayerName, prayerTime) {
            if (scheduledNotifications[prayerName]) { return; }
            if (!('Notification' in window)) { alert('This browser does not support desktop notification'); return; }
            Notification.requestPermission().then(permission => {
                if (permission === 'granted') {
                    scheduleNotification(prayerName, prayerTime);
                    document.querySelector(`#bell-${prayerName}`).classList.add('active');
                    scheduledNotifications[prayerName] = true;
                }
            });
        }

        function scheduleNotification(prayerName, prayerTime) {
            const now = new Date();
            const timeDiff = prayerTime.getTime() - now.getTime();
            if (timeDiff > 0) {
                setTimeout(() => {
                    new Notification('Prayer Time!', { body: `It's time for ${prayerName} prayer.`, icon: 'image_95c516.jpg' });
                    document.getElementById('adhan-audio').play().catch(e => console.error("Error playing adhan:", e));
                    delete scheduledNotifications[prayerName];
                    document.querySelector(`#bell-${prayerName}`).classList.remove('active');
                }, timeDiff);
                alert(`Notification set for ${prayerName} at ${formatTime(prayerTime.toTimeString())}.`);
            } else { alert(`${prayerName} time has already passed for today.`); }
        }

        async function searchLocation() {
            const locationInput = document.getElementById('location-input');
            const suggestionsBox = document.getElementById('suggestions-box');
            const city = locationInput.value.trim();
            suggestionsBox.classList.add('hidden');
            if (!city) return;
            showLoader();
            try {
                const geoResponse = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(city)}&format=json&limit=1`);
                if (!geoResponse.ok) throw new Error('Geocoding service failed.');
                const geoData = await geoResponse.json();
                if (geoData.length === 0) throw new Error(`Could not find location: ${city}`);
                const { lat, lon, display_name } = geoData[0];
                locationInput.value = display_name.split(',')[0];
                handleNewCoordinates(parseFloat(lat), parseFloat(lon));
            } catch (error) { showError(`Could not find location for "${city}". Please try another name.`); }
        }

        async function fetchLocationSuggestions(query) {
            const suggestionsBox = document.getElementById('suggestions-box');
            if (query.length < 3) { suggestionsBox.classList.add('hidden'); return; }
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?city=${encodeURIComponent(query)}&format=json&limit=5&addressdetails=1`);
                const data = await response.json();
                displaySuggestions(data);
            } catch (error) { console.error("Suggestion fetch error:", error); suggestionsBox.classList.add('hidden'); }
        }

        function displaySuggestions(suggestions) {
            const suggestionsBox = document.getElementById('suggestions-box');
            suggestionsBox.innerHTML = '';
            if (suggestions.length === 0) { suggestionsBox.classList.add('hidden'); return; }
            suggestions.forEach(place => {
                const suggestionItem = document.createElement('div');
                suggestionItem.className = 'p-2 hover:bg-gray-700 cursor-pointer text-sm';
                suggestionItem.textContent = place.display_name;
                suggestionItem.onclick = () => {
                    document.getElementById('location-input').value = place.display_name;
                    suggestionsBox.classList.add('hidden');
                    searchLocation();
                };
                suggestionsBox.appendChild(suggestionItem);
            });
            suggestionsBox.classList.remove('hidden');
        }
        
        function formatTime(time24) {
            if (!time24) return 'N/A';
            const timeString = time24.split(' ')[0];
            const [hours, minutes] = timeString.split(':');
            const h = parseInt(hours, 10);
            const ampm = h >= 12 ? 'PM' : 'AM';
            const h12 = h % 12 || 12;
            return `${String(h12).padStart(2, '0')}:${minutes} ${ampm}`;
        }
        
        function showLoader() {
            loader.classList.remove('hidden');
            errorMessage.classList.add('hidden');
            mainContent.classList.add('hidden');
        }

        function showError(message) {
            loader.classList.add('hidden');
            errorMessage.classList.remove('hidden');
            mainContent.classList.add('hidden');
            errorText.textContent = message;
        }

        function showMainContent() {
            loader.classList.add('hidden');
            errorMessage.classList.add('hidden');
            mainContent.classList.remove('hidden');
        }
        
        // --- 5. Qibla Direction Logic ---
        function calculateQiblaDirection(lat, lon) {
            const kaabaLat = 21.4225 * Math.PI / 180;
            const userLat = lat * Math.PI / 180;
            const lonDiff = (39.8262 - lon) * Math.PI / 180;
            
            const y = Math.sin(lonDiff) * Math.cos(kaabaLat);
            const x = Math.cos(userLat) * Math.sin(kaabaLat) - Math.sin(userLat) * Math.cos(kaabaLat) * Math.cos(lonDiff);
            
            let bearing = Math.atan2(y, x) * 180 / Math.PI;
            bearing = (bearing + 360) % 360; // Normalize to 0-360
            return bearing;
        }

        function handleDeviceOrientation(event) {
            const compassRose = document.getElementById('compass-rose');
            const qiblaNeedle = document.getElementById('qibla-needle');
            const qiblaDirection = parseFloat(document.getElementById('qibla-direction-degrees').textContent);
            
            let heading = event.webkitCompassHeading || event.alpha; // webkit for iOS
            if (heading === null) {
                document.getElementById('qibla-error').textContent = 'Compass heading not available.';
                document.getElementById('qibla-error').classList.remove('hidden');
                return;
            }

            compassRose.style.transform = `rotate(${-heading}deg)`;
            qiblaNeedle.style.transform = `rotate(${qiblaDirection}deg)`;
        }
        
        function startQiblaCompass() {
            const qiblaError = document.getElementById('qibla-error');
            qiblaError.classList.add('hidden');
            
            if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission()
                    .then(permissionState => {
                        if (permissionState === 'granted') {
                            window.addEventListener('deviceorientation', handleDeviceOrientation);
                            showQiblaCompass();
                        } else {
                            qiblaError.textContent = 'Permission to access device orientation was denied.';
                            qiblaError.classList.remove('hidden');
                        }
                    })
                    .catch(console.error);
            } else if ('DeviceOrientationEvent' in window) {
                window.addEventListener('deviceorientation', handleDeviceOrientation);
                showQiblaCompass();
            } else {
                qiblaError.textContent = 'Device orientation is not supported by this browser.';
                qiblaError.classList.remove('hidden');
            }
        }
        
        function showQiblaCompass() {
            if (!currentLatitude) {
                document.getElementById('qibla-error').textContent = 'Location not available. Please allow location access first.';
                document.getElementById('qibla-error').classList.remove('hidden');
                return;
            }
            const qiblaDirection = calculateQiblaDirection(currentLatitude, currentLongitude);
            document.getElementById('qibla-direction-degrees').textContent = qiblaDirection.toFixed(2);
            document.getElementById('qibla-permission-prompt').classList.add('hidden');
            document.getElementById('qibla-compass-container').classList.remove('hidden');
        }

        // --- Event Listeners ---
        document.getElementById('allow-location-btn').addEventListener('click', requestLocationPermission);
        document.getElementById('deny-location-btn').addEventListener('click', () => {
            locationConsentModal.classList.add('hidden');
            showError("Location access is required for automatic prayer times. Please search for a location manually.");
            handleNewCoordinates(21.4225, 39.8262); // Fallback
        });
        document.getElementById('privacy-policy-btn').addEventListener('click', () => privacyPolicyModal.classList.remove('hidden'));
        document.getElementById('close-privacy-btn').addEventListener('click', () => privacyPolicyModal.classList.add('hidden'));
        document.getElementById('start-qibla-btn').addEventListener('click', startQiblaCompass);

        mainNavButtons.forEach(button => {
            button.addEventListener('click', () => {
                switchView(button.dataset.target);
            });
        });

        document.getElementById('daily-view-btn').addEventListener('click', () => {
            document.getElementById('daily-view').classList.remove('hidden');
            document.getElementById('monthly-view').classList.add('hidden');
            document.getElementById('daily-view-btn').classList.add('active');
            document.getElementById('monthly-view-btn').classList.remove('active');
            if(currentLatitude) fetchDailyData();
        });

        document.getElementById('monthly-view-btn').addEventListener('click', () => {
            document.getElementById('daily-view').classList.add('hidden');
            document.getElementById('monthly-view').classList.remove('hidden');
            document.getElementById('daily-view-btn').classList.remove('active');
            document.getElementById('monthly-view-btn').classList.add('active');
            if (currentLatitude && document.getElementById('monthly-table-body').innerHTML === '') {
                fetchMonthlyData();
            }
        });

        document.getElementById('method-select').addEventListener('change', (e) => {
            currentMethod = e.target.value;
            if(currentLatitude) handleNewCoordinates(currentLatitude, currentLongitude);
        });
        
        document.getElementById('location-input').addEventListener('input', () => {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                fetchLocationSuggestions(document.getElementById('location-input').value);
            }, 300);
        });

        document.getElementById('location-input').addEventListener('keyup', (e) => { if (e.key === 'Enter') searchLocation(); });
        
        document.addEventListener('click', (e) => {
            const locationInput = document.getElementById('location-input');
            const suggestionsBox = document.getElementById('suggestions-box');
            if (!locationInput.contains(e.target) && !suggestionsBox.contains(e.target)) {
                suggestionsBox.classList.add('hidden');
            }
        });

        // --- Initial Load ---
        window.onload = showLocationConsent;

    </script>
</body>
</html>
